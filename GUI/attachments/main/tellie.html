<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>TELLIE Control Interface (Time to turn on the TELLIE)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1	.0">
    <meta name="description" content="TELLIE Control Interface">
    <meta name="author" content="James Waterfield @ University of Sussex for SNO+">

    <!-- Le styles -->
    <link href="../assets/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
		background-color:#FFFFFF;     
		}

    </style>
    <link href="../assets/css/bootstrap-responsive.css" rel="stylesheet">
	<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  
  	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
  	<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
  </head>
 
<body>

   <div class="navbar navbar-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="#">TELLIE Control Panel</a>
          <ul style="width: 80%" class="nav" role="navigation">
            <li style="float: right"><a href="ellie.html"> ELLIE Controls </a></li>
          </ul>
        </div>
      </div>
    </div>


    <div class="container">
        	<div class="row-fluid">				

				<div class="well span3" id="global_settings_input">
				<h4 id="global_settings">Global Settings:</h4>
					<div class="control-group">
                		<label class="control-label" for="run_no">Run ID</label>
                        <div class="controls">
                            <input type="number" id="run_no_id" placeholder="e.g. 5768 (Read from ORCA)">
			</div>

                        </div>
			<div class="control-group">
                		<label class="control-label" for="operator_name">Operator Name</label>
                        <div class="controls">
                            <input type="text" id="operator_name_id" placeholder="e.g. Bill Murray">
                        </div>

			<div class="control-group">
                		<label class="control-label" for="pulse_number">Number of Pulses</label>
                        <div class="controls">
                          <input type="number" id="pulse_number_id" placeholder="e.g. 1000">
                        </div>
			</div>

			<div class="control-group">
                		<label class="control-label" for="pulse_frequency">Pulse Frequency (Hz)</label>
                        <div class="controls">
                          <input type="number" id="pulse_frequency_id" placeholder="e.g. 10">
                        </div>
			</div>

			<div class="control-group">
                		<label class="control-label" for="trigger_delay">Trigger Delay (ns)</label>
                        <div class="controls">
                          <input type="number" id="trigger_delay_id" placeholder="e.g. 600">
                        </div>
			</div>
                    </div>
			
		</div> 	

				<div class="well span3" id="inputTable">
					<h4>Channel Presets:</h4>
                	<div class="control-group">
                		<label class="control-label" for="channel">Channel Number</label>
                        <div class="controls">
                            <input type="number" id="channel_id" placeholder="Integer: 0 - 96">
                        </div>
                    </div>
						
			        <form>	
                		<label class="control-label" for="channel">Number of Photons</label>
						<select name="number_of_photons" id="number_of_photons_id" >
							<option value="1000000">1,000,000</option>
							<option value="100000">100,000</option>
							<option value="10000">10,000</option>
							<option value="1000">1,000</option>			
						</select>
					</form>

			<div class="control-group">
					<a onClick="loadTelliePreset()" class="btn btn btn-action">Load Preset</a>
			</div>
                    </div>

				<div class="well span3" id="channel_settings_input">
				<h4 id="channel_settings">Channel Settings:<br>(Load Preset First)</h4>
					<div class="control-group">
                		<label class="control-label" for="channel2">Channel Number</label>
                        <div class="controls">
                            <input type="number" id="channel2_id" placeholder="Integer: 0 - 96">
                        </div>
                    </div>
				
					<div class="control-group">
                		<label class="control-label" for="iop">Pulse Height (IOP)</label>
                        <div class="controls">
                            <input type="number" id="iop_id" placeholder="Integer: 0 (Min) - 16383 (Max)">
                        </div>
                    </div>

					<div class="control-group">
                		<label class="control-label" for="ipw">Pulse Width (IPW)</label>
                        <div class="controls">
                            <input type="number" id="ipw_id" placeholder="Integer: 0 (Max) - 16383 (Min)">
                        </div>
                    </div>
					<div class="control-group">
                		<label class="control-label" for="fibre_delay">Fibre Delay (ns)</label>
                        <div class="controls">
                            <input type="number" id="fibre_delay_id" placeholder="Time in ns">
                        </div>
                    </div>

		</div> 	

					<div class="well span3" id="startButtons"> 
					<h4>TELLIE Run Control:</h4><br>
						<div class="control-group">
							<a onClick="loadTellie()" class="btn btn btn-action" id="startButton">Load</a>
						</div>

						<div class="control-group">
							<a onClick="submitToTellieDaq()" class="btn btn btn-primary">Fire!</a>
						</div>
						<div class="control-group">
							<a href="#" class="btn btn btn-danger">Configuration Settings</a>
						</div>							
					</div>
					 
					<div class="well span3" id="inputErrors", style="display:none"><h4></div>
					<div id="hiddenJSON"></div>
				
            </div>
        </div>
    </div>

	<script>
	/* ERROR FLAGS --------------------------------------------------*/
	var runIdFlag = 0;                                                      //TELLIE run Id flag
	var numPulsesIdFlag=0;                                                  //Number of pulses Id flag
	var pulseFreqIdFlag=0;                                                  //Pulse frequency Id flag
	var trigDelayIdFlag=0;                                                  //Trigger delay Id flag
	var channelIdFlag=0;                                                    //Channel Id flag
	var iopIdFlag=0;                                                        //IOP Id flag
	var ipwIdFlag=0;                                                        //IPW Id flag
	var fibreDelayIdFlag=0;                                                 //Fibre delay Id flag
	var totalErrorMessage;							//Complete Error Message
	var stopRunAbility = 10; 						//Stop a run from occuring (defaults to 10 to indicate the loading is not yet safe
	/*------------------------------------------------------------------*/

	
	function clearErrorDiv(){
		$("#inputErrors").css( "display", "none");				//reset the input error html
		totalErrorMessage = "<h4>Input ERRORS:</h4><ul>";		//reset the error message	
	
	}

	function loadTelliePreset(){

	
	    clearErrorDiv(); //clear and setup the error message catch	

	    //Number of photons
	    var num_phot_el = document.getElementById("number_of_photons_id"); //get the photon number HTML element
	    var num_phot = num_phot_el.options[num_phot_el.selectedIndex].value; //return the selected photon number on the laser Selector HTML element

	    //Channel field
	    var chan1 = $("#channel_id").val();
	    if (!chan1){
	       channelIdFlag = 1;
	       alert("Channel number not set, fill both fields.");
	       totalErrorMessage = totalErrorMessage + "<li><h6>Error: Channel number not set.</h6></li>";
	    }

            else if (chan1 < 0 ||chan1 > 96){
		channelIdFlag = 1;
	        alert("Error: Invalid channel number. Channel number ranges between 0 - 96");
	        totalErrorMessage = totalErrorMessage + "<li><h6>Error: Inavlid channel number. Channel number ranges between 0 - 96</h6></li>";
	    } 

	    else{
	        channelIdFlag = 0;
                }

	    var errorFlagSum = channelIdFlag;

	    if(errorFlagSum > 0){ //disable the start button
		totalErrorMessage =  '<img src="Ellie_Fail.gif">'+"<br>"+totalErrorMessage+"</ul>"; //close the bullet point of error message before printing
	        $('#inputErrors').html(totalErrorMessage);
	        $("#inputErrors").css( "display", "block");
	        return;
	     }

	//Use channel number and no of photons to extract IOP, IPW, fibre delay from DB
	// Following is a placeholder for now...
	IOP = 16383;
	IPW = 6000;
	fib_delay = 0;
	// End of placeholder
	
	var chan2_elem = document.getElementById("channel2_id");
	chan2_elem.value = chan1;
	
	var iop_elem = document.getElementById("iop_id");
	iop_elem.value = IOP;

	var ipw_elem = document.getElementById("ipw_id");
	ipw_elem.value = IPW;

	 var fib_elem = document.getElementById("fibre_delay_id");
	 fib_elem.value = fib_delay;
			
}	 //End of the load preset button



	function loadTellie(){

		var timeStamp = new Date().getTime(); //returns the current time in epoch format (time in ms from January 1970)	
	
		clearErrorDiv(); //clear and setup the error message catch	

		// Run ID (currently the User inputs this from ORCA)
		var run_id = $("#run_no_id").val();
		if(!run_id.length){ //if the run ID is not set
			run_id = 1;			
			totalErrorMessage = totalErrorMessage + "<li><h6>Run ID is not set! Defaulting to 1!</h6></li>";
			runIdFlag = 1;
		}
		else{
			runIdFlag = 0;
		}
	
		// Operator of the TELLIE Run
		var author = $("#operator_name_id").val();
		if (author == ""){
			author = "No Author Specified";
		}					
	        //Number of pulses per channel
	        var num_pulses = $("#pulse_number_id").val();
	        if (!num_pulses){
	               numPulsesIdFlag = 1;
	               alert("Number of pulses not set");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Number of pulses not set</h6></li>";
	        }
                else if (num_pulses < 0 || num_pulses > 65025){
	               numPulsesIdFlag = 1;
	               alert("Error: Inavlid number of pulses. Number of pulses ranges between 0 - 65025");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Inavlid number of pulses. Number of pulses ranges between 0 - 65025</h6></li>";
	        } 
	        else{
	               numPulsesIdFlag = 0;
                }

		//Pulse Frequency
	        var pulse_freq = $("#pulse_frequency_id").val();
	        if (!pulse_freq){
	               pulseFreqIdFlag = 1;
	               alert("Pulse frequency not set");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Pulse frequency not set</h6></li>";

	        }

                else if (pulse_freq < 0 || pulse_freq > 250000){
	               pulseFreqIdFlag = 1;
	               alert("Error: Invalid pulse frequency. Pulse frequency ranges between 0 - 250000 Hz");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Inavlid pulse frequency. Pulse frequency ranges between 0 - 250000 Hz</h6></li>";
	        } 
	        else{
	               pulseFreqIdFlag = 0;
                }

	        //Trigger Delay
	        var trig_delay = $("#trigger_delay_id").val();
	        if (!trig_delay){
	               trigDelayIdFlag = 1;
	               alert("Trigger delay not set");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Trigger delay not set</h6></li>";

	        }

                else if (trig_delay < 0 || trig_delay > 1275){
	               trigDelayIdFlag = 1;
	               alert("Error: Invalid trigger delay. Trigger delay ranges between 0 - 1275 ns");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Inavlid trigger delay. Trigger delay ranges between 0 - 1275 ns</h6></li>";
	        } 

	        else{
	               trigDelayIdFlag = 0;
                }

		//Channel fields
	        var chan1 = $("#channel_id").val();
	        var chan2 = $("#channel2_id").val();
	        if (!chan1 || !chan2){
	               channelIdFlag = 1;
		  console.log("chan1"+chan1);
		  console.log("chan2"+chan2);
	               alert("Channel number not set, fill both fields.");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Channel number not set, fill both fields</h6></li>";
	        }

                else if (chan1 < 0 || chan1 > 96 || chan2 < 0 || chan2 > 96){
	               channelIdFlag = 1;
	               alert("Error: Invalid channel number. Channel number ranges between 0 - 96");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Inavlid channel number. Channel number ranges between 0 - 96</h6></li>";
	        } 

	        else{
	               channelIdFlag = 0;
                }

	        //Pulse Height
	        var IOP = $("#iop_id").val();
	        if (!IOP){
	               iopIdFlag = 1;
	               alert("Pulse height (IOP) not set");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Pulse height (IOP) not set</h6></li>";

	        }

                else if (IOP < 0 || IOP > 16383){
	               iopIdFlag = 1;
	               alert("Error: Invalid pulse height (IOP). Pulse height (IOP) ranges between 0 - 16383");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Inavlid pulse height (IOP). Pulse height (IOP) ranges between 0 - 16383</h6></li>";
	        } 

	        else{
	               iopIdFlag = 0;
                }

	        //Pulse Width
	        var IPW = $("#ipw_id").val();
	        if (!IPW){
	               ipwIdFlag = 1;
	               alert("Pulse width (IPW) not set");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Pulse width (IPW) not set</h6></li>";

	        }

                else if (IPW < 0 || IPW > 16383){
	               ipwIdFlag = 1;
	               alert("Error: Invalid pulse width (IPW). Pulse width (IPW) ranges between 0 - 16383");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Inavlid pulse width (IPW). Pulse width (IPW) ranges between 0 - 16383</h6></li>";
	        } 

	        else{
	               ipwIdFlag = 0;
                }

	        //Fibre Delay
	        var fib_delay = $("#fibre_delay_id").val();
	        if (!fib_delay){
	               fibreDelayIdFlag = 1;
	               alert("Fibre delay not set");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Fibre delay not set</h6></li>";

	        }

                else if (fib_delay < 0 || fib_delay > 63.75){
	               fibreDelayIdFlag = 1;
	               alert("Error: Invalid Fibre delay. Fibre delay ranges between 0 - 1275 ns");
	               totalErrorMessage = totalErrorMessage + "<li><h6>Error: Inavlid fibre delay. Trigger delay ranges between 0 - 63.75 ns</h6></li>";
	        } 

	        else{
	               fibreDelayIdFlag = 0;
                }
	
	       var errorFlagSum = runIdFlag  + numPulsesIdFlag + pulseFreqIdFlag + trigDelayIdFlag + channelIdFlag + iopIdFlag + ipwIdFlag +fibreDelayIdFlag;

	       stopRunAbility = errorFlagSum; 

		    if(errorFlagSum > 0){ //disable the start button
		    totalErrorMessage =  '<img src="Ellie_Fail.gif">'+"<br>"+totalErrorMessage+"</ul>"; //close the bullet point of error message before printing
  	            $('#inputErrors').html(totalErrorMessage);
	            $("#inputErrors").css( "display", "block");
                    return; //exit from firing
                   }

		    
		    

	var jsonTellieRunFile = '{"doc_type": "source","run_name": "TELLIE", "time_stamp": ' + timeStamp + ',"approved": true,"hw": [{"id":'+chan2+',"pulse_width":'+IPW+',"pulse_height":'+IOP+',"fibre_delay":'+fib_delay+'}], "run_list": [{"id": 0, "hw": [ ],"author":' + author + ',"led_selected":[' + chan2 + '], "ellie_driven": true,"detector_forced_readout": true,"nb_pulses":'+num_pulses+',"ellie_pulse_rate":'+pulse_freq+',"ellie_trigger_delay":'+trig_delay+',"subrun_loop_number":1}]}';	
	
	console.log(jsonTellieRunFile);
	$("#hiddenJSON").css('display','none');
	$("#hiddenJSON").html(jsonTellieRunFile);


}

function submitToTellieDaq(){

	    clearErrorDiv(); //clear and setup the error message catch	

           if(stopRunAbility > 0){
			alert("Cannot start TELLIE run, please refer to input settings");
		    totalErrorMessage =  '<img src="Ellie_Fail.gif">'+"<br>"+totalErrorMessage+"<h6>Channel settings not correctly loaded first. Load settings first!</h6></ul>"; //close the bullet point of error message before printing
		}
		else{
			//submit to the TELLIE DAQ (or ORCA in the future or both depending on future run scheme)
			var jsonTellieRunFile = $("#hiddenJSON").html();
			console.log(jsonTellieRunFile);
			$.ajax(
				{
					url: "http://couch.snopl.us/tellie",
					type: 'POST',
					data: jsonTellieRunFile,
					dataType: 'json',
					contentType: 'application/json; charset=utf-8',
					success: alert("Staring run..."), 
				});
        totalErrorMessage =  '<img src="Ellie_Happy.gif">'+"<br><h6>Run Submitted!</h6>";	
		}
	

	    
	$('#inputErrors').html(totalErrorMessage);
	$("#inputErrors").css( "display", "block");
			

}
	
	</script>


	 <!-- Le javascript 
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../assets/js/jquery.js"></script>
    <script src="../assets/js/bootstrap-transition.js"></script>
    <script src="../assets/js/bootstrap-alert.js"></script>
    <script src="../assets/js/bootstrap-modal.js"></script>
    <script src="../assets/js/bootstrap-dropdown.js"></script>
    <script src="../assets/js/bootstrap-scrollspy.js"></script>
    <script src="../assets/js/bootstrap-tab.js"></script>
    <script src="../assets/js/bootstrap-tooltip.js"></script>
    <script src="../assets/js/bootstrap-popover.js"></script>
    <script src="../assets/js/bootstrap-button.js"></script>
    <script src="../assets/js/bootstrap-collapse.js"></script>
    <script src="../assets/js/bootstrap-carousel.js"></script>
    <script src="../assets/js/bootstrap-typeahead.js"></script>

</body>
</html>
